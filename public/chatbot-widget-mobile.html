<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Achora Chat Widget</title>
    <style type="text/css">@font-face {font-family:Montserrat;font-style:normal;font-weight:400;src:url(/cf-fonts/v/montserrat/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:400;src:url(/cf-fonts/v/montserrat/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:400;src:url(/cf-fonts/v/montserrat/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:400;src:url(/cf-fonts/v/montserrat/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:400;src:url(/cf-fonts/v/montserrat/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:500;src:url(/cf-fonts/v/montserrat/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:500;src:url(/cf-fonts/v/montserrat/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:500;src:url(/cf-fonts/v/montserrat/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:500;src:url(/cf-fonts/v/montserrat/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:500;src:url(/cf-fonts/v/montserrat/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:600;src:url(/cf-fonts/v/montserrat/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:600;src:url(/cf-fonts/v/montserrat/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:600;src:url(/cf-fonts/v/montserrat/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:600;src:url(/cf-fonts/v/montserrat/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:600;src:url(/cf-fonts/v/montserrat/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:700;src:url(/cf-fonts/v/montserrat/5.0.16/cyrillic-ext/wght/normal.woff2);unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:700;src:url(/cf-fonts/v/montserrat/5.0.16/latin-ext/wght/normal.woff2);unicode-range:U+0100-02AF,U+0304,U+0308,U+0329,U+1E00-1E9F,U+1EF2-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:700;src:url(/cf-fonts/v/montserrat/5.0.16/cyrillic/wght/normal.woff2);unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:700;src:url(/cf-fonts/v/montserrat/5.0.16/vietnamese/wght/normal.woff2);unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+0300-0301,U+0303-0304,U+0308-0309,U+0323,U+0329,U+1EA0-1EF9,U+20AB;font-display:swap;}@font-face {font-family:Montserrat;font-style:normal;font-weight:700;src:url(/cf-fonts/v/montserrat/5.0.16/latin/wght/normal.woff2);unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+0304,U+0308,U+0329,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD;font-display:swap;}</style>
    <style>
        /* --- General Setup & Body --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
            font-weight: 400;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: transparent;
            overflow: hidden;
        }

        /* --- Main Chat Container --- */
        .chat-container {
            width: 100%;
            height: 100%;
            height: -webkit-fill-available; /* iOS Safari fix */
            max-width: 420px;
            max-height: 800px;
            background: #ffffff;
            border-radius: 25px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* iOS-specific fixes - keep widget small but prevent overflow */
        @supports (-webkit-touch-callout: none) {
            .chat-container {
                max-height: calc(100vh - 40px); /* Ensure it fits in iOS viewport with margin */
            }
        }

        /* --- Chat Header --- */
        .chat-header {
            background: #11B3B1;
            color: white;
            padding: 20px 15px;
            position: relative;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
            margin-right: 15px;
        }

        .maple-logo {
            width: 100%;
            max-width: 200px;
            height: auto;
        }

        .status-indicator {
            background: white;
            border: 1px solid #11B3B1;
            color: #11B3B1;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            flex-shrink: 0;
            margin-right: 45px;
        }

            .status-indicator.offline {
                flex-direction: column;
                padding: 6px 10px;
                text-align: center;
                line-height: 1.2;
                font-size: 10px;
            }

            .status-indicator .dot {
                width: 7px;
                height: 7px;
                background: #11B3B1;
                border-radius: 50%;
                flex-shrink: 0;
            }

            .status-indicator.offline .dot {
                display: none;
            }

        /* Mobile Close Button */
        .mobile-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            background: rgba(0, 0, 0, 0.2);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

            .mobile-close-btn:hover {
                background: rgba(0, 0, 0, 0.3);
            }

            .mobile-close-btn svg {
                width: 20px;
                height: 20px;
                fill: #fff;
            }

        /* --- Chat Messages Area --- */
        .chat-messages {
            flex: 1;
            padding: 20px 15px;
            overflow-y: auto;
            background: #ffffff;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 18px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: fadeInUp 0.3s ease;
        }

            .message.user {
                justify-content: flex-end;
            }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            flex-shrink: 0;
            overflow: hidden;
        }

            .message-avatar img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .message.bot .message-avatar {
            background: #E8F7F7;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .message.bot .message-avatar img {
                width: 60%;
                height: 60%;
            }

        .message.human .message-avatar {
            background: #2196F3;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .message.human .message-avatar img {
                width: 60%;
                height: 60%;
            }

        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.bot .message-content {
            background: #E8F7F7;
            color: #003362;
            border-bottom-left-radius: 6px;
        }

        .message.human .message-content {
            background: #11B3B1;
            color: white;
            border-bottom-left-radius: 6px;
        }

        .message.bot .message-content ul {
            padding-left: 20px;
            margin: 8px 0;
        }

        .message.bot .message-content li {
            margin-bottom: 4px;
        }

        .message.user .message-content {
            background: #916CB1;
            color: white;
            border-bottom-right-radius: 6px;
        }

        /* Quick Reply Buttons */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0 20px 0;
            padding-left: 50px;
        }

        .quick-reply-btn {
            background: white;
            border: 2px solid #333;
            color: #333;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

            .quick-reply-btn:hover,
            .quick-reply-btn:active {
                background: #f1f2f6;
                transform: scale(0.98);
            }

        /* Typing Indicator */
        .typing-indicator {
            display: none;
        }

        .typing-dots {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

            .typing-dots span {
                width: 6px;
                height: 6px;
                border-radius: 50%;
                background-color: #999;
                animation: typing 1.4s infinite ease-in-out;
            }

                .typing-dots span:nth-child(1) {
                    animation-delay: -0.32s;
                }

                .typing-dots span:nth-child(2) {
                    animation-delay: -0.16s;
                }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Suggestion buttons */
        .suggestion-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

            .suggestion-buttons button {
                padding: 8px 16px;
                border-radius: 20px;
                border: none;
                font-size: 12px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                flex: 1;
                min-width: 80px;
            }

            .suggestion-buttons .accept-btn {
                background: #11B3B1;
                color: white;
            }

            .suggestion-buttons .callback-btn {
                background: #FDC200;
                color: #003362;
            }

            .suggestion-buttons .decline-btn {
                background: #916CB1;
                color: white;
            }

            .suggestion-buttons button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }

        /* --- Chat Input Area --- */
        .chat-input-container {
            padding: 10px 15px;
            background: #e8e8e8;
            border-top: 1px solid #f1f2f6;
            flex-shrink: 0;
            position: relative;
            z-index: 100;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #dfe4ea;
            border-radius: 25px;
            padding: 5px;
            transition: border-color 0.3s ease;
            min-height: 46px;
        }

            .chat-input-wrapper:focus-within {
                border-color: #11B3B1;
            }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px;
            font-size: 14px;
            outline: none;
            color: #3d3d3d;
            resize: none;
        }

            .chat-input::placeholder {
                color: #a4b0be;
                font-size: 13px;
            }

        .send-button {
            background: #11B3B1;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

            .send-button:hover:not(:disabled) {
                background: #0D9290;
                transform: scale(1.05);
            }

            .send-button svg {
                width: 20px;
                height: 20px;
                fill: white;
            }

            .send-button:disabled {
                background: #ddd;
                cursor: not-allowed;
                transform: none;
            }

        /* Connection Status */
        .connection-status {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #ff4757;
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 12px;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

            .connection-status.show {
                transform: translateY(0);
            }

            .connection-status.success {
                background: #2ed573;
            }

        /* --- Mobile Responsive Styles --- */
        @media (max-width: 768px) {
            /* Chat container as floating centered widget */
            .chat-container {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                width: 90% !important;
                max-width: 380px !important;
                height: 560px !important;
                border-radius: 20px !important;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3) !important;
                z-index: 9999 !important;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }

            /* Show close button on mobile */
            .mobile-close-btn {
                display: flex;
            }

            /* Adjust header for mobile */
            .chat-header {
                padding: 12px !important;
                min-height: 60px !important;
            }

            .maple-logo {
                max-width: 140px !important;
            }

            .status-indicator {
                font-size: 9px !important;
                padding: 4px 8px !important;
            }

            /* Messages area with fixed height */
            .chat-messages {
                flex: 1;
                overflow-y: auto !important;
                padding: 15px 12px !important;
                -webkit-overflow-scrolling: touch;
            }

            /* Input container stays at bottom */
            .chat-input-container {
                position: relative !important;
                padding: 10px !important;
                border-radius: 0 0 20px 20px !important;
                flex-shrink: 0;
            }

            .chat-input-wrapper {
                border-radius: 20px !important;
                padding: 4px !important;
            }

            .chat-input {
                padding: 8px 10px !important;
                font-size: 14px !important;
            }

            .send-button {
                width: 32px !important;
                height: 32px !important;
            }

            /* Smaller message elements */
            .message-content {
                font-size: 13px !important;
                padding: 10px 14px !important;
            }

            .message-avatar {
                width: 35px !important;
                height: 35px !important;
            }

            /* Adjust quick replies */
            .quick-replies {
                padding-left: 45px !important;
            }

            .quick-reply-btn {
                font-size: 11px !important;
                padding: 6px 12px !important;
            }

            /* Full-width suggestion buttons */
            .suggestion-buttons {
                flex-direction: column;
                gap: 6px;
            }

                .suggestion-buttons button {
                    width: 100%;
                    font-size: 11px !important;
                    padding: 8px !important;
                }
        }

        /* For very small phones */
        @media (max-width: 380px) {
            .chat-container {
                height: 500px !important;
                width: 95% !important;
            }

            .maple-logo {
                max-width: 120px !important;
            }
        }

        /* Tablet adjustments */
        @media (min-width: 769px) and (max-width: 1024px) {
            .chat-container {
                max-width: 450px;
                max-height: 650px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        Connecting...
    </div>

    <div class="chat-container">
        <div class="chat-header">
            <div class="header-left">
                <h1 style="font-size: 36px; font-weight: 700; color: white; margin: 0; letter-spacing: 2px;">achora</h1>
            </div>
            <div class="status-indicator" id="statusIndicator">
                <span class="dot"></span>
                <span class="status-text">Our team is online</span>
            </div>
            <button class="mobile-close-btn" id="mobileCloseBtn" onclick="closeMobileChat()">
                <svg viewBox="0 0 24 24">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
            </button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Initial Messages -->
            <div class="message bot">
                <div class="message-avatar">
                    <img src="https://maplecommunity.com.au/wp-content/uploads/MCS-Icon-ChatBot.png" alt="Bot Avatar" onerror="this.style.display='none'">
                </div>
                <div class="message-content">
                    <p>Whether you're new to NDIS, considering switching providers, or just have questions, our diverse and caring team is here to support you every step of the way. What brings you to Achora today? ‚≠ê</p>
                </div>
            </div>


            <!-- Typing indicator -->
            <div class="typing-indicator message bot" id="typingIndicator">
                <div class="message-avatar">
                    <img src="https://maplecommunity.com.au/wp-content/uploads/MCS-Icon-ChatBot.png" alt="Bot Avatar" onerror="this.style.display='none'">
                </div>
                <div class="message-content">
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <input type="text" class="chat-input" id="messageInput" placeholder="How can we help today?" maxlength="500" autocomplete="off">
                <button class="send-button" id="sendButton" aria-label="Send message">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Global variables
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const statusIndicator = document.getElementById('statusIndicator');
        const connectionStatus = document.getElementById('connectionStatus');

        const WEBHOOK_URL = 'https://maplecommunity-api-test.up.railway.app/chat';
        let sessionId = null; // Will be created when widget is first opened
        let persistentUserId = null; // Persistent user identifier across sessions
        let isConnectedToHuman = false;
        let socket = null;
        let conversationHistory = [];
        let isConnected = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 3;
        let waitingStartTime = null;
        let waitingTimerInterval = null;
        let widgetInitialized = false;
        let isRestoringFromStorage = false;

        function initializeWithSession() {
            if (sessionId && !widgetInitialized) {
                // Initialize persistent user ID and restore chat history
                initializePersistentUserId();
                restoreChatHistory();
                initializeWebSocket();
                widgetInitialized = true;
            }
        }

        // Initialize persistent user ID and restore chat history immediately on page load
        function initializeOnLoad() {
            // Try to initialize persistent user ID even without session ID
            initializePersistentUserId();

            // If we have a persistent user ID, restore chat history
            if (persistentUserId) {
                restoreChatHistory();
            }
        }
        
        function initializePersistentUserId() {
            // If persistent user ID already set, don't override
            if (persistentUserId) {
                return;
            }

            try {
                // Try to get existing persistent user ID
                persistentUserId = localStorage.getItem('achora_persistent_user_id');

                if (!persistentUserId) {
                    // Generate new persistent user ID
                    persistentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('achora_persistent_user_id', persistentUserId);
                    console.log('üçÅ Generated new persistent user ID:', persistentUserId);
                } else {
                    console.log('üçÅ Restored persistent user ID:', persistentUserId);
                }
            } catch (error) {
                console.error('Error initializing persistent user ID:', error);
                // Fallback: generate a temporary ID
                persistentUserId = 'temp_user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
        }
        
        function restoreChatHistory() {
            try {
                console.log('üçÅ Attempting to restore chat history for user:', persistentUserId);
                if (!persistentUserId) {
                    console.log('üçÅ No persistentUserId available, skipping restoration');
                    return;
                }
                
                const storedData = localStorage.getItem(`achora_chat_history_${persistentUserId}`);
                console.log('üçÅ Stored data found:', !!storedData);
                if (storedData) {
                    const data = JSON.parse(storedData);
                    const now = Date.now();
                    const oneHourMs = 60 * 60 * 1000; // 1 hour in milliseconds
                    
                    // Check if data is expired (older than 1 hour)
                    if (data.timestamp && (now - data.timestamp) > oneHourMs) {
                        console.log('üçÅ Chat history expired (older than 1 hour), clearing...');
                        localStorage.removeItem(`achora_chat_history_${persistentUserId}`);
                        localStorage.removeItem('achora_persistent_user_id');
                        console.log('üçÅ Persistent user ID also cleared due to expiration');
                        return; // Don't restore expired data
                    }
                    
                    const parsedHistory = data.messages || data; // Support both new and legacy formats
                    if (Array.isArray(parsedHistory) && parsedHistory.length > 0) {
                        isRestoringFromStorage = true;
                        console.log('üçÅ Restoring chat history:', parsedHistory.length, 'messages for user:', persistentUserId);
                        
                        // Clear existing messages except initial bot message and typing indicator
                        const existingMessages = chatMessages.querySelectorAll('.message:not(.typing-indicator)');
                        existingMessages.forEach((msg, index) => {
                            // Keep the first bot message (welcome message)
                            if (index > 0) {
                                msg.remove();
                            }
                        });
                        
                        // Restore messages
                        parsedHistory.forEach(msg => {
                            addMessage(msg.message, msg.sender === 'user', msg.sender === 'human', false); // false = don't save to localStorage
                        });
                        
                        conversationHistory = [...parsedHistory];
                        isRestoringFromStorage = false;
                        scrollToBottom();
                    }
                }
            } catch (error) {
                console.error('Error restoring chat history:', error);
                isRestoringFromStorage = false;
            }
        }
        
        function saveChatHistory() {
            if (isRestoringFromStorage || !persistentUserId) {
                console.log('üçÅ Skipping save - isRestoring:', isRestoringFromStorage, 'persistentUserId:', persistentUserId);
                return;
            }
            
            try {
                // Save with timestamp for 1-hour expiration
                const dataToSave = {
                    timestamp: Date.now(),
                    messages: conversationHistory
                };
                localStorage.setItem(`achora_chat_history_${persistentUserId}`, JSON.stringify(dataToSave));
                console.log('üçÅ Saved chat history for user:', persistentUserId, 'messages:', conversationHistory.length);
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        }

        // Listen for session ID and persistent user ID from parent window
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'achora-session-id') {
                sessionId = event.data.sessionId;
                // If parent provides persistent user ID, use it; otherwise initialize our own
                if (event.data.persistentUserId) {
                    persistentUserId = event.data.persistentUserId;
                    console.log('üçÅ Received persistent user ID from parent:', persistentUserId);
                }
                initializeWithSession();
            }
        });

        // Utility functions
        function formatWaitingTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (minutes > 0) {
                return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
            return `${seconds} seconds`;
        }

        // iOS viewport fix for dynamic height adjustment
        function isiOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        function adjustIOSViewport() {
            if (isiOS()) {
                const chatContainer = document.querySelector('.chat-container');
                if (chatContainer) {
                    // Keep the widget small (800px max) but ensure it fits in iOS viewport
                    const actualHeight = window.visualViewport ? 
                        window.visualViewport.height : 
                        window.innerHeight;
                    
                    // Only adjust if the widget would be too tall for the viewport
                    const maxAllowedHeight = Math.min(800, actualHeight - 40); // 40px margin
                    chatContainer.style.maxHeight = `${maxAllowedHeight}px`;
                }
            }
        }

        // Apply iOS fixes when page loads
        document.addEventListener('DOMContentLoaded', function() {
            adjustIOSViewport();
        });

        // Listen for viewport changes on iOS
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', adjustIOSViewport);
        }

        // Fallback for older iOS versions
        window.addEventListener('resize', function() {
            if (isiOS()) {
                setTimeout(adjustIOSViewport, 100);
            }
        });

        function startWaitingTimer() {
            // Clear any existing timer
            if (waitingTimerInterval) {
                clearInterval(waitingTimerInterval);
            }

            // Add initial waiting message with timer
            const timerDiv = document.createElement('div');
            timerDiv.id = 'waiting-timer';
            timerDiv.style.textAlign = 'center';
            timerDiv.style.margin = '15px 10px';
            timerDiv.innerHTML = `
                <div style="background:#e3f2fd; color:#1565c0; padding:10px 16px; border-radius:16px; border:1px solid #90caf9; font-size:13px; display:inline-block; max-width:90%;">
                    <span style="font-weight:600;">Waiting for Support Specialist...</span>
                    <br>
                    <span style="font-size:11px;">Waiting time: <span id="timer-display">0 seconds</span></span>
                </div>
            `;
            chatMessages.insertBefore(timerDiv, typingIndicator);
            scrollToBottom();

            // Update timer every second
            waitingTimerInterval = setInterval(() => {
                if (waitingStartTime) {
                    const elapsedSeconds = Math.floor((Date.now() - waitingStartTime) / 1000);
                    const timerDisplay = document.getElementById('timer-display');
                    if (timerDisplay) {
                        timerDisplay.textContent = formatWaitingTime(elapsedSeconds);
                    }
                }
            }, 1000);
        }

        function stopWaitingTimer() {
            if (waitingTimerInterval) {
                clearInterval(waitingTimerInterval);
                waitingTimerInterval = null;
            }
            waitingStartTime = null;
            
            // Remove timer display
            const timerDiv = document.getElementById('waiting-timer');
            if (timerDiv) {
                timerDiv.remove();
            }
        }

        function showConnectionStatus(message, isSuccess = false) {
            connectionStatus.textContent = message;
            connectionStatus.className = `connection-status ${isSuccess ? 'success' : ''} show`;
            setTimeout(() => {
                connectionStatus.classList.remove('show');
            }, 3000);
        }

        function isWithinWorkingHours() {
            try {
                const now = new Date();
                const australianTime = new Date(now.toLocaleString("en-US", { timeZone: "Australia/Sydney" }));
                const hours = australianTime.getHours();
                const day = australianTime.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday

                // Check if it's a weekday (Monday to Friday) and within business hours
                // Weekends (Saturday=6, Sunday=0) are always considered after hours
                const isWeekday = day >= 1 && day <= 5;
                const isBusinessTime = hours >= 9 && hours < 17;

                return isWeekday && isBusinessTime;
            } catch (error) {
                console.error('Error checking working hours:', error);
                return false;
            }
        }

        function updateTeamStatus() {
            const isOnline = isWithinWorkingHours();
            const dot = statusIndicator.querySelector('.dot');
            const statusText = statusIndicator.querySelector('.status-text');

            if (isOnline) {
                statusIndicator.style.display = 'flex';
                statusIndicator.classList.remove('offline');
                if (dot) dot.style.display = 'block';
                if (statusText) statusText.innerHTML = 'Our team is online';
                // Reset logo position to normal when online
                const headerLeft = document.querySelector('.header-left');
                if (headerLeft) {
                    headerLeft.style.justifyContent = '';
                    headerLeft.style.flex = '';
                }
            } else {
                // Hide status indicator completely when offline
                statusIndicator.style.display = 'none';
                // Center the logo when status indicator is hidden
                const headerLeft = document.querySelector('.header-left');
                if (headerLeft) {
                    headerLeft.style.justifyContent = 'center';
                    headerLeft.style.flex = '1';
                }
            }
        }

        // Check if there's an active session with a Support Specialist on page load/refresh
        async function checkSessionState() {
            console.log('üîç Checking session state on page load...');
            console.log('üîç SessionId:', sessionId, 'PersistentUserId:', persistentUserId);

            // Don't send request if session or persistent user ID are null/undefined
            if (!sessionId || !persistentUserId) {
                console.log('üîç Skipping session state check - session or persistent user ID not initialized');
                return;
            }

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: '__CHECK_SESSION_STATE__',
                        sessionId: sessionId,
                        persistentUserId: persistentUserId,
                        type: 'check_session_state'
                    })
                });
                
                const data = await response.json();
                console.log('üîç Session state check response:', data);
                
                // If user is connected to a Support Specialist, restore the UI state
                if (data.type === 'specialist_connected' || data.specialistConnected) {
                    console.log('üîÑ Restoring Support Specialist connection state');
                    isConnectedToHuman = true;
                    showSpecialistConnectedUI();
                    
                    // Add specialist connected system message to chat
                    const specialistName = data.specialistName || 'Support Specialist';
                    addSystemMessage(`${specialistName} has joined the conversation. You are now chatting with a Support Specialist.`);
                } 
                // If user is waiting for a specialist, show static waiting text (no timer after refresh)
                else if (data.type === 'waiting_for_specialist' && data.waiting && data.waitingStartTime) {
                    console.log('üîÑ Restoring waiting state with static text');
                    
                    // Add static waiting text without timer (mobile version)
                    const timerDiv = document.createElement('div');
                    timerDiv.id = 'waiting-timer';
                    timerDiv.style.textAlign = 'center';
                    timerDiv.style.margin = '15px 10px';
                    timerDiv.innerHTML = `
                        <div style="background:#e3f2fd; color:#1565c0; padding:10px 16px; border-radius:16px; border:1px solid #90caf9; font-size:13px; display:inline-block; max-width:90%;">
                            <span style="font-weight:600;">Waiting for Support Specialist...</span>
                        </div>
                    `;
                    chatMessages.insertBefore(timerDiv, typingIndicator);
                    scrollToBottom();
                }
            } catch (error) {
                console.log('‚ùå Could not check session state:', error);
            }
        }
        
        function showSpecialistConnectedUI() {
            // Show the specialist status indicator
            const statusIndicator = document.querySelector('.status-indicator');
            const statusText = document.querySelector('.status-text');
            const statusSubText = document.querySelector('.status-sub-text');
            
            if (statusIndicator && statusText) {
                statusIndicator.classList.add('connected');
                statusText.textContent = 'Connected to Support Specialist';
                if (statusSubText) {
                    statusSubText.textContent = 'You are now chatting with a Support Specialist';
                }
            }
        }


        // WebSocket functions
        function initializeWebSocket() {
            try {
                console.log('üîå Connecting to WebSocket...');
                socket = io('https://maplecommunity-api-test.up.railway.app', {
                    timeout: 10000,
                    forceNew: true
                });

                socket.on('connect', () => {
                    console.log('‚úÖ WebSocket connected:', socket.id);
                    isConnected = true;
                    reconnectAttempts = 0;
                    socket.emit('join_session', sessionId);
                    
                    // Check if there's an active Support Specialist session on reconnect
                    checkSessionState();
                });

                socket.on('disconnect', (reason) => {
                    console.log('‚ùå WebSocket disconnected:', reason);
                    isConnected = false;
                    showConnectionStatus('Connection lost. Retrying...');

                    if (reason === 'io server disconnect') {
                        setTimeout(() => {
                            if (reconnectAttempts < maxReconnectAttempts) {
                                reconnectAttempts++;
                                initializeWebSocket();
                            }
                        }, 2000);
                    }
                });

                socket.on('connect_error', (error) => {
                    console.error('‚ùå WebSocket connection error:', error);
                    isConnected = false;
                });

                socket.on('agent_connected', (data) => {
                    if (!isConnectedToHuman) {
                        isConnectedToHuman = true;
                        stopWaitingTimer(); // Stop the waiting timer
                        addSystemMessage(data.message || 'A human agent has joined the chat');
                    }
                });

                socket.on('agent_message', (data) => {
                    hideTyping();
                    addMessage(data.message, false, true);
                });

                socket.on('agent_disconnected', (data) => {
                    isConnectedToHuman = false;
                    stopWaitingTimer(); // Stop timer if disconnected
                    addSystemMessage(data.message || 'The human agent has left the chat');
                });

                socket.on('handoff_timeout', (data) => {
                    console.log('‚è∞ Handoff request timed out:', data);
                    // Hide any waiting UI elements
                    stopWaitingTimer();
                    hideHandoffButtons();
                    isWaitingForAgent = false;
                    // The system message will come through the regular 'message' event
                });

            } catch (error) {
                console.error('Error initializing WebSocket:', error);
                showConnectionStatus('Connection failed. Chat still available.');
            }
        }

        function trackLinkClick(url) {
            // Set localStorage flag to auto-open widget on next page
            try {
                localStorage.setItem('achora_auto_open_widget', 'true');
                console.log('üçÅ Set auto-open flag for next page');
            } catch (error) {
                console.error('Error setting auto-open flag:', error);
            }

            // Log link click to the database
            fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Link clicked: ${url}`,
                    sessionId: sessionId,
                    persistentUserId: persistentUserId, // Include persistent user ID
                    type: 'link_click',
                    metadata: {
                        clickedUrl: url,
                        eventType: 'link_click'
                    }
                })
            }).catch(error => {
                console.error('Error tracking link click:', error);
            });
        }

        // Message formatting
        function formatBotResponse(text) {
            if (!text) return '';

            // Convert URLs to clickable links first with onclick tracking
            text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" onclick="trackLinkClick(\'$1\')" style="color: #11B3B1; text-decoration: underline;">$1</a>');
            
            // Then handle markdown formatting
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

            let lines = text.split('\n');
            let formattedLines = [];
            let inList = false;
            let listType = '';

            for (let line of lines) {
                let isOrdered = /^\d+\.\s/.test(line);
                let isUnordered = /^[-‚Ä¢]\s/.test(line);

                if (isOrdered || isUnordered) {
                    if (!inList) {
                        listType = isOrdered ? 'ol' : 'ul';
                        formattedLines.push(`<${listType}>`);
                        inList = true;
                    }
                    formattedLines.push('<li>' + line.replace(/^\d+\.\s|^[-‚Ä¢]\s/, '') + '</li>');
                } else {
                    if (inList) {
                        formattedLines.push(`</${listType}>`);
                        inList = false;
                    }
                    if (line.trim()) formattedLines.push('<p>' + line + '</p>');
                }
            }
            if (inList) formattedLines.push(`</${listType}>`);
            return formattedLines.join('');
        }

        // Message handling
        function addMessage(text, isUser = false, isHuman = false, saveToStorage = true) {
            if (!text) return;

            const messageObj = {
                sender: isUser ? 'user' : (isHuman ? 'human' : 'bot'),
                message: text,
                timestamp: new Date().toISOString()
            };
            
            conversationHistory.push(messageObj);

            // Keep only last 20 messages for better persistence
            if (conversationHistory.length > 20) {
                conversationHistory = conversationHistory.slice(-20);
            }
            
            // Save to localStorage unless we're restoring from storage
            if (saveToStorage) {
                saveChatHistory();
            }

            const messageType = isUser ? 'user' : (isHuman ? 'human' : 'bot');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${messageType}`;

            if (!isUser) {
                const avatarDiv = document.createElement('div');
                avatarDiv.className = 'message-avatar';
                avatarDiv.innerHTML = `<img src="https://maplecommunity.com.au/wp-content/uploads/MCS-Icon-ChatBot.png" alt="Bot Avatar" onerror="this.style.display='none'">`;
                messageDiv.appendChild(avatarDiv);
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = isUser ? `<p>${escapeHtml(text)}</p>` : formatBotResponse(text);

            messageDiv.appendChild(contentDiv);
            chatMessages.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
        }

        function addSystemMessage(text) {
            if (!text) return;

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = 'text-align: center; margin: 10px 0;';
            messageDiv.innerHTML = `<span style="background:#fff3cd; color:#856404; padding:8px 12px; border-radius:15px; border:1px solid #ffeaa7; font-size:12px; font-style:italic;">${escapeHtml(text)}</span>`;
            chatMessages.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
        }

        function addHandoffSuggestion() {
            const isOnline = isWithinWorkingHours();
            const suggestionText = "It seems like you might benefit from speaking with someone from our team. Would you like me to connect you with a Support Specialist?";

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';

            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            avatarDiv.innerHTML = `<img src="https://maplecommunity.com.au/wp-content/uploads/MCS-Icon-ChatBot.png" alt="Bot Avatar" onerror="this.style.display='none'">`;
            messageDiv.appendChild(avatarDiv);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            let buttonsHTML = `<button class="decline-btn" onclick="handleHandoffResponse('decline')">Continue Chat</button>`;

            if (isOnline) {
                buttonsHTML = `
                        <button class="accept-btn" onclick="handleHandoffResponse('accept')">Accept</button>
                        <button class="callback-btn" onclick="handleHandoffResponse('callback')">Request Call Back</button>
                    ` + buttonsHTML;
            } else {
                buttonsHTML = `<button class="callback-btn" onclick="handleHandoffResponse('callback')">Request Callback</button>` + buttonsHTML;
            }

            contentDiv.innerHTML = `<p>${suggestionText}</p><div class="suggestion-buttons">${buttonsHTML}</div>`;
            messageDiv.appendChild(contentDiv);
            chatMessages.insertBefore(messageDiv, typingIndicator);
            scrollToBottom();
            
            // Disable text input while handoff buttons are shown
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            messageInput.disabled = true;
            sendButton.disabled = true;
            messageInput.placeholder = 'Please choose an option above...';
        }

        async function handleHandoffResponse(response) {
            // Session should already be initialized by parent window
            if (!sessionId) {
                console.warn('No session ID available from parent window');
                return;
            }

            const suggestionButtons = document.querySelectorAll('.suggestion-buttons');
            suggestionButtons.forEach(button => button.remove());
            
            // Re-enable text input after button selection
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.placeholder = 'We\'re here to make NDIS simpler, how can we help today?';
            messageInput.focus();

            try {
                if (response === 'accept') {
                    const apiResponse = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: 'User accepted human handoff',
                            sessionId: sessionId,
                            persistentUserId: persistentUserId, // Include persistent user ID
                            type: 'accept_human_handoff',
                            conversationHistory: conversationHistory
                        })
                    });

                    if (!apiResponse.ok) {
                        throw new Error(`HTTP error! status: ${apiResponse.status}`);
                    }
                    
                    // Start the waiting timer
                    waitingStartTime = Date.now();
                    startWaitingTimer();

                } else if (response === 'callback') {
                    const callbackMessage = "I would like to request a callback. Can you please help me schedule a call?";
                    addMessage(callbackMessage, true);
                    showTyping();

                    const callbackResponse = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: callbackMessage,
                            sessionId: sessionId,
                            persistentUserId: persistentUserId, // Include persistent user ID
                            type: 'user_to_bot',
                            isHumanConnected: false
                        })
                    });

                    if (!callbackResponse.ok) {
                        throw new Error(`HTTP error! status: ${callbackResponse.status}`);
                    }

                    const responseData = await callbackResponse.json();
                    const botMessage = extractBotResponse(responseData);

                    hideTyping();
                    addMessage(botMessage, false);

                } else {
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: 'User declined human handoff',
                            sessionId: sessionId,
                            persistentUserId: persistentUserId, // Include persistent user ID
                            type: 'decline_human_handoff',
                            isHumanConnected: false,
                            isBusinessHours: isWithinWorkingHours()
                        })
                    });

                    if (response.ok) {
                        const responseData = await response.json();
                        const botMessage = extractBotResponse(responseData);
                        addMessage(botMessage, false);
                    } else {
                        addMessage("No worries! I'll continue to help you. What else can I assist you with today?", false);
                    }
                }
                
                // Track continue conversation event when user declines handoff
                if (response === 'decline') {
                    trackEvent('CONTINUE_PRESSED');
                }
            } catch (error) {
                console.error('Error handling handoff response:', error);
                if (response === 'accept') {
                    addSystemMessage("Sorry, we couldn't connect you right now. Please try again.");
                } else if (response === 'callback') {
                    hideTyping();
                    addMessage("I apologize, but I'm having trouble processing your callback request. Please try again or call us directly.", false);
                } else {
                    addMessage("No worries! I'll continue to help you. What else can I assist you with today?", false);
                }
                
                // Track continue conversation event when user declines handoff (in error case too)
                if (response === 'decline') {
                    trackEvent('CONTINUE_PRESSED');
                }
            }
        }

        // UI helper functions
        function scrollToBottom() {
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        function showTyping() {
            typingIndicator.style.display = 'flex';
            scrollToBottom();
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        function extractBotResponse(responseData) {
            if (typeof responseData === 'string') return responseData;
            return responseData.output || responseData.message || "Sorry, I encountered an issue. Please try again.";
        }

        async function trackEvent(eventType) {
            try {
                await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `TRACK_EVENT_${eventType}`,
                        sessionId: sessionId,
                        persistentUserId: persistentUserId, // Include persistent user ID
                        type: 'track_event',
                        eventType: eventType
                    })
                });
            } catch (error) {
                console.log('Event tracking failed:', error);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Main send message function
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Session should already be initialized by parent window
            if (!sessionId) {
                console.warn('No session ID available from parent window');
                return;
            }

            // Disable input while waiting for response
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            addMessage(message, true);
            messageInput.value = '';

            if (!isConnectedToHuman) showTyping();

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        sessionId: sessionId,
                        persistentUserId: persistentUserId, // Include persistent user ID
                        type: isConnectedToHuman ? 'user_to_human' : 'user_to_bot',
                        isHumanConnected: isConnectedToHuman
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const responseData = await response.json();
                hideTyping();

                if (!isConnectedToHuman) {
                    if (responseData.type === 'human_handoff_suggestion') {
                        if (responseData.output) {
                            addMessage(responseData.output, false);
                        }
                        addHandoffSuggestion();
                    } else {
                        addMessage(extractBotResponse(responseData), false);
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
                hideTyping();
                addMessage('I apologize - I seem to be having a connection issue. Please try again in a moment.', false);
            } finally {
                // Re-enable input after response (success or error), unless handoff buttons are showing
                const handoffButtonsPresent = document.querySelector('.suggestion-buttons');
                if (!handoffButtonsPresent) {
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                }
                
                // Keep focus and keyboard visible on mobile (only if input is enabled)
                if (!handoffButtonsPresent) {
                    if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                        setTimeout(() => {
                            messageInput.focus();
                            // For iOS specifically
                            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                                messageInput.click();
                            }
                        }, 10);
                    } else {
                        messageInput.focus();
                    }
                }
            }
        }

        function askQuestion(question) {
            messageInput.value = question;
            sendMessage();
        }

        function closeMobileChat() {
            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage({ type: 'closeMobileChat' }, '*');
                    window.parent.postMessage('closeMobileChat', '*');
                }
                if (window.close) {
                    window.close();
                }
            } catch (error) {
                console.error('Error closing chat:', error);
            }
        }

        // Event listeners
        messageInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Add click listener to send button with proper focus handling
        sendButton.addEventListener('click', function (e) {
            e.preventDefault();
            sendMessage();
            // Keep focus on mobile
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                messageInput.focus();
            }
        });

        // Prevent button from stealing focus on mobile
        sendButton.addEventListener('touchstart', function (e) {
            e.preventDefault();
            sendMessage();
            messageInput.focus();
        });

        // Simplified mobile keyboard handling
        function handleMobileKeyboard() {
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                messageInput.addEventListener('focus', () => {
                    setTimeout(() => {
                        scrollToBottom();
                    }, 300);
                });
            }
        }

        // Initialize everything
        function initialize() {
            try {
                // Initialize status checking only (WebSocket will be initialized when session received from parent)
                updateTeamStatus();
                handleMobileKeyboard();

                setInterval(updateTeamStatus, 60000);

                if (!/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                    setTimeout(() => {
                        messageInput.focus();
                    }, 500);
                }

                console.log('‚úÖ Chat widget initialized successfully');
            } catch (error) {
                console.error('‚ùå Error initializing chat widget:', error);
                showConnectionStatus('Error loading chat. Please refresh.');
            }
        }

        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }

        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && !isConnected) {
                initializeWebSocket();
            }
        });

        // Initialize persistent user ID and restore chat history on page load
        initializeOnLoad();

        // Ensure chat history is saved before any page navigation
        window.addEventListener('beforeunload', function() {
            console.log('üçÅ BEFOREUNLOAD: Saving chat history, messages:', conversationHistory.length, 'userID:', persistentUserId);
            saveChatHistory();
        });
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"dfad4bdd721f42288440c1d5c0909557","server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>